<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI App Generator</title>
  <link rel="stylesheet" href="/github-style.css">
</head>

<body>
  <div class="container">
    <header>
      <h1>AI App Generator</h1>
      <p>Describe any app and generate it instantly using LLM Foundry</p>
    </header>

    <!-- Input Section -->
    <div class="input-section">
      <label for="appDescription">Describe your app:</label>
      <textarea id="appDescription"
        placeholder="Example: Create a PDF summarizer app..."
        rows="4"></textarea>

      <div class="examples">
        <p>Quick Examples:</p>
        <button class="example-btn" onclick="setExample('todo')">Todo List</button>
        <button class="example-btn" onclick="setExample('calculator')">Calculator</button>
        <button class="example-btn" onclick="setExample('weather')">Weather App</button>
        <button class="example-btn" onclick="setExample('pdf')">PDF Summarizer</button>
      </div>

      <!-- Side-by-side buttons -->
      <div class="action-row">
        <button class="generate-btn" onclick="generateApp()">Generate App</button>
        <button class="rectify-btn" id="rectifyBtnTop" onclick="rectifyCode()" style="display:none;">
          Rectify / Improve Code
        </button>
        <button class="deploy-btn" onclick="deployToGithub()">
          Deploy to GitHub
        </button>
      </div>

      <div class="loading" id="loading">Working...</div>
      <div class="error" id="error"></div>

      <div id="deployInfo" class="deploy-info" style="display:none; margin-top: 10px;">
        <p>Last deployment:</p>
        <p>
          <a id="repoLink" href="#" target="_blank" style="display:none; margin-right: 10px;">
            View Repository
          </a>
          <a id="liveLink" href="#" target="_blank" style="display:none;">
            View Deployed App
          </a>
        </p>
        <p id="deployedFile" style="font-size: 0.9rem; color: #555;"></p>
      </div>
    </div>

    <!-- Split Layout -->
    <div class="split-container" id="splitContainer">
      <div class="code-section">
        <div class="section-header">
          <h3>Generated Code</h3>
          <button onclick="copyCode()">Copy Code</button>
        </div>
        <pre id="codeDisplay">// Your code will appear here...</pre>
      </div>

      <div class="resizer" id="resizer"></div>

      <div class="preview-section">
        <div class="section-header">
          <h3>Live Preview</h3>
          <button onclick="openInNewTab()">Open in New Tab</button>
        </div>
        <iframe id="previewFrame"></iframe>
      </div>
    </div>

    <!-- Popup Rectify -->
    <div id="rectifyPopup" class="popup">
      <div class="popup-content">
        <h3>ðŸ’¬ Suggest a Correction</h3>
        <textarea id="rectifyInput"
          placeholder="Example: Add dark mode or fix layout..."
          rows="5"></textarea>

        <div class="popup-buttons">
          <button id="rectifySubmit" onclick="submitRectification()">Submit</button>
          <button id="rectifyCancel" onclick="closeRectifyPopup()">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    window.generatedCode = window.generatedCode || '';
    window.repoUrl = null;
    window.pagesUrl = null;
    window.deployedFilename = null;

    const BACKEND_API_URL = "";
    const API_ENDPOINT = BACKEND_API_URL + '/generate';
    const RECTIFY_ENDPOINT = BACKEND_API_URL + '/rectify';
    const DEPLOY_ENDPOINT = BACKEND_API_URL + '/deploy';

    const examples = {
      todo: 'Create a todo list app where users can add, complete, and delete tasks.',
      calculator: 'Build a calculator app with basic arithmetic operations.',
      weather: 'Create a weather app showing temperature and humidity for a city.',
      timer: 'Build a timer/stopwatch app with start, stop, and reset.',
      pdf: 'Create a PDF summarizer app that uploads a PDF, extracts text, and summarizes it using the LLM Foundry API.'
    };

    function setExample(type) {
      document.getElementById('appDescription').value = examples[type];
    }

    async function generateApp() {
      const desc = document.getElementById('appDescription').value.trim();
      if (!desc) return showError('Please enter an app description!');

      showLoading(true, "Generating your app...");
      hideError();
      hideDeployInfo();

      try {
        const response = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ description: desc })
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || errorData.detail || 'Failed to generate app');
        }

        const data = await response.json();
        const code = data.code;

        window.generatedCode = code;
        window.repoUrl = null;
        window.pagesUrl = null;
        window.deployedFilename = null;

        // keep compatibility with rectifyCode
        generatedCode = code;

        displayCode(code);
        updatePreview(code);
        document.getElementById("rectifyBtnTop").style.display = "inline-block";

      } catch (e) {
        showError('Failed to generate app: ' + (e?.message || e));
      } finally {
        showLoading(false);
      }
    }

    async function deployToGithub() {
      if (!window.generatedCode) {
        return showError("Please generate an app before deploying to GitHub.");
      }

      const desc = document.getElementById('appDescription').value.trim() || "App";

      showLoading(true, "Deploying to GitHub...");
      hideError();

      try {
        const response = await fetch(DEPLOY_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code: window.generatedCode, description: desc })
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || errorData.detail || 'Failed to deploy to GitHub');
        }

        const data = await response.json();
        window.repoUrl = data.repo_url || null;
        window.pagesUrl = data.pages_url || null;
        window.deployedFilename = data.filename || null;

        updateDeployInfo(window.repoUrl, window.pagesUrl, window.deployedFilename);
        showError("âœ“ Deployed latest generated app to GitHub.");

      } catch (e) {
        showError('Deployment failed: ' + (e?.message || e));
      } finally {
        showLoading(false);
      }
    }

    function copyCode() {
      navigator.clipboard.writeText(window.generatedCode || '')
        .then(() => alert('âœ“ Code copied!'))
        .catch(e => showError('Copy failed: ' + e.message));
    }

    function openInNewTab() {
      if (!window.generatedCode) {
        return showError("No generated code to open.");
      }
      const w = window.open();
      w.document.write(window.generatedCode);
      w.document.close();
    }

    function displayCode(code) {
      document.getElementById('codeDisplay').textContent = code || '// No code generated yet';
    }

    function updatePreview(code) {
      const iframeDoc = document.getElementById('previewFrame').contentDocument;
      iframeDoc.open();
      iframeDoc.write(code || '');
      iframeDoc.close();
    }

    function showLoading(show, text) {
      const loadingEl = document.getElementById('loading');
      if (text) loadingEl.textContent = text;
      loadingEl.classList.toggle('active', show);
    }

    function showError(msg) {
      const e = document.getElementById('error');
      e.textContent = msg;
      e.classList.add('active');
      setTimeout(() => e.classList.remove('active'), 6000);
    }

    function hideError() {
      document.getElementById('error').classList.remove('active');
    }

    function hideDeployInfo() {
      document.getElementById('deployInfo').style.display = 'none';
    }

    // -------- RECTIFICATION (unchanged behavior) --------
    function rectifyCode() {
      if (!generatedCode) return showError("No code available to improve.");
      document.getElementById("rectifyPopup").style.display = "flex";
    }

    async function submitRectification() {
      const feedback = document.getElementById("rectifyInput").value.trim();
      if (!feedback) return showError("Please describe what to fix.");

      document.getElementById("rectifyPopup").style.display = "none";
      showLoading(true, "Improving code...");
      hideError();

      try {
        const response = await fetch(RECTIFY_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ code: generatedCode, feedback })
        });

        const data = await response.json();
        generatedCode = data.code;
        window.generatedCode = data.code;

        displayCode(generatedCode);
        updatePreview(generatedCode);
        showError("âœ“ Code improved based on your feedback!");

      } catch (err) {
        showError("Failed to refine code: " + err.message);
      } finally {
        showLoading(false);
      }
    }

    function closeRectifyPopup() {
      document.getElementById("rectifyPopup").style.display = "none";
    }

    // -------- Deploy info section --------
    function updateDeployInfo(repoUrl, pagesUrl, filename) {
      const info = document.getElementById('deployInfo');
      const repoLink = document.getElementById('repoLink');
      const liveLink = document.getElementById('liveLink');
      const fileText = document.getElementById('deployedFile');

      if (repoUrl) {
        repoLink.href = repoUrl;
        repoLink.style.display = 'inline-block';
      } else {
        repoLink.style.display = 'none';
      }

      if (pagesUrl) {
        liveLink.href = pagesUrl;
        liveLink.style.display = 'inline-block';
      } else {
        liveLink.style.display = 'none';
      }

      if (filename) {
        fileText.textContent = "File: " + filename;
      } else {
        fileText.textContent = "";
      }

      info.style.display = (repoUrl || pagesUrl || filename) ? 'block' : 'none';
    }

    /* ============================
          DRAGGABLE RESIZER
    ============================ */
    const resizer = document.getElementById("resizer");
    const container = document.getElementById("splitContainer");
    let isDragging = false;

    resizer.addEventListener("mousedown", function () {
      isDragging = true;
      document.body.style.cursor = "col-resize";
    });

    document.addEventListener("mousemove", function (e) {
      if (!isDragging) return;
      const offset = e.clientX - container.offsetLeft;
      const percentLeft = (offset / container.clientWidth) * 100;

      if (percentLeft > 20 && percentLeft < 80) {
        container.children[0].style.flex = percentLeft;
        container.children[2].style.flex = 100 - percentLeft;
      }
    });

    document.addEventListener("mouseup", function () {
      isDragging = false;
      document.body.style.cursor = "default";
    });
  </script>

</body>
</html>
